<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products with Prices and Categories</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.7.12/umd.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        /* Style  pour les en-têtes de colonnes */
        .dataTables thead th {
            background-color: #f5f5f5; /* Couleur de fond pour les en-têtes de colonnes */
            border: 1px solid #ccc; /* Couleur de bordure pour les en-têtes de colonnes */
            color: #333; /* Couleur du texte pour les en-têtes de colonnes */
        }
    </style>
</head>
<body>
    <img src="static/images/ing.jpeg" alt="banniere ingredient" width="700">
    <h1>Search for products on Open Food Facts</h1>
    <input type="text" id="searchQuery" placeholder="Enter product name" />
    <button onclick="searchProduct()">Search</button>
    <table id="productsTable" class="display">
        <thead>
            <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>Brand</th>
                <th class="nutriscore">Nutri-Score</th>
                <th>Ingredients</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <!-- Modal pour les détails du produit -->
    <div class="modal fade" id="productDetailsModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Ingredients</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Les détails du produit seront affichés ici -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            var table = $('#productsTable').DataTable({
                "columnDefs": [
                    { "orderable": false, "targets": [0, 5, 6] },
                    { "className": "nutriscore", "targets": [3] }
                ]
            });
            // Charger les prix enregistrés lorsque la page est chargée
            loadPrices();
            // Gestionnaire d'événements pour cliquer sur une ligne du tableau
            $('#productsTable tbody').on('click', 'tr', function() {
                var row = table.row(this).data();
                var ingredients = row[4];
                showIngredients(ingredients);
            });
            // Gestionnaire d'événements pour cliquer sur le lien des détails du produit
            $('#productsTable tbody').on('click', 'tr', function(e) {
                // Vérifier si l'élément cliqué est un input ou un bouton
                if ($(e.target).is('input, button')) {
                    // Empêcher la propagation si l'élément cliqué est un input ou un bouton
                    e.stopPropagation();
                    return;
                }
                // afficher les ingrédients
                var row = table.row(this).data();
                var ingredients = row[4];
                showIngredients(ingredients);
            });
        });
        function searchProduct() {
            var query = $('#searchQuery').val();
            if (query) {
                fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${query}&search_simple=1&action=process&json=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.products.length === 0) {
                            alert('No products found');
                            return;
                        }
                        updateTable(data.products);
                    })
                    .catch(error => {
                        console.error(error);
                        alert('Error when searching for products.');
                    });
            } else {
                alert('Please enter a product name.');
            }
        }
        function updateTable(products) {
            var table = $('#productsTable').DataTable();
            table.clear();
            products.forEach(product => {
                var priceId = 'price-' + product._id;
                var ingredients = product.ingredients_text_fr || 'Inconnu';
                table.row.add([
                    product.image_url ? `<img src="${product.image_url}" style="width:50px;height:auto;">` : 'Pas d\'image',
                    product.product_name || 'Inconnu',
                    product.brands || 'Inconnu',
                    product.nutrition_grades || 'Inconnu',
                    ingredients,
                    `<input type="number" id="${priceId}" placeholder="€" style="width:70px;" value="${localStorage.getItem(priceId) || ''}">`,
                    `<button onclick="savePrice('${product._id}')">Sauvegarder</button>` // Ajouté pour la colonne 'Actions'
                ]);
            });
            table.draw();
        }
        function showIngredients(ingredients) {
            $('#productDetailsModal .modal-body').text(ingredients);
            $('#productDetailsModal').modal('show');
        }
        function savePrice(productId) {
            var priceId = 'price-' + productId;
            var price = $('#' + priceId).val();
            localStorage.setItem(priceId, price);
            alert('Price saved for product ID ' + productId);
        }
        function loadPrices() {
            $('#productsTable input[type="number"]').each(function() {
                var priceId = $(this).attr('id');
                $(this).val(localStorage.getItem(priceId) || '');
            });
        }
    </script>
</body>
</html>
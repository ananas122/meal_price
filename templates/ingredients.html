<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produits avec Prix et Catégories</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.7.12/umd.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        /* Neutral style for column headers */
        .dataTables thead th {
            background-color: #f5f5f5; /* Background color for column headers */
            border: 1px solid #ccc; /* Border color for column headers */
            color: #333; /* Text color for column headers */
        }
    </style>
    
</head>
  <img src="static/images/ing.jpeg" alt="banniere ingredient" width="700">

<body>

    <h1>Recherche de produit sur Open Food Facts</h1>

    <input type="text" id="searchQuery" placeholder="Entrez le nom du produit" />
    <button onclick="searchProduct()">Rechercher</button>

    <table id="productsTable" class="display">
        <thead>
            <tr>
                <th>Photo</th>
                <th>Nom</th>
                <th>Marque</th>
                <th class="nutriscore">Nutri-Score</th>
                <th>Ingredients</th>
                <th>Prix</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <!-- Modal for product details -->
    <div class="modal fade" id="productDetailsModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Ingrédients</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Product details will be displayed here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            var table = $('#productsTable').DataTable({
                "columnDefs": [
                    { "orderable": false, "targets": [0, 5, 6] },
                    { "className": "nutriscore", "targets": [3] }
                ]
            });

            // Load saved prices when the page is loaded
            loadPrices();

            // Event handler for clicking on a table row
            $('#productsTable tbody').on('click', 'tr', function() {
                var row = table.row(this).data();
                var ingredients = row[4];
                showIngredients(ingredients);
            });

            // Event handler for clicking on the product details link
            $('#productsTable tbody').on('click', '.product-details-link', function(e) {
                e.preventDefault();
                var row = table.row($(this).closest('tr')).data();
                var ingredients = row[4];
                $('#productDetailsModal .modal-body').text(ingredients);
                $('#productDetailsModal').modal('show');
            });
        });

        function searchProduct() {
            var query = $('#searchQuery').val();
            if (query) {
                fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${query}&search_simple=1&action=process&json=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.products.length === 0) {
                            alert('Aucun produit trouvé.');
                            return;
                        }
                        updateTable(data.products);
                    })
                    .catch(error => {
                        console.error(error);
                        alert('Erreur lors de la recherche de produits.');
                    });
            } else {
                alert('Veuillez entrer un nom de produit.');
            }
        }

        function updateTable(products) {
            var table = $('#productsTable').DataTable();
            table.clear();
            products.forEach(product => {
                var priceId = 'price-' + product._id;
                var ingredients = product.ingredients_text_fr || 'Inconnu';
                table.row.add([
                    product.image_url ? `<img src="${product.image_url}" style="width:50px;height:auto;">` : 'Pas d\'image',
                    product.product_name || 'Inconnu',
                    product.brands || 'Inconnu',
                    product.nutrition_grades || 'Inconnu',
                    `<a href="#" class="product-details-link">Détails</a>`,
                    `<input type="number" id="${priceId}" placeholder="€" style="width:70px;" value="${localStorage.getItem(priceId) || ''}">`,
                    `<button onclick="savePrice('${product._id}')">Sauvegarder</button>`
                ]);
            });
            table.draw();
        }

        function showIngredients(ingredients) {
            $('#productDetailsModal .modal-body').text(ingredients);
            $('#productDetailsModal').modal('show');
        }

        function savePrice(productId) {
            var priceId = 'price-' + productId;
            var price = $('#' + priceId).val();
            localStorage.setItem(priceId, price);
            alert('Prix sauvegardé pour le produit ID ' + productId);
        }

        function loadPrices() {
            $('#productsTable input[type="number"]').each(function() {
                var priceId = $(this).attr('id');
                $(this).val(localStorage.getItem(priceId) || '');
            });
        }
    </script>
</body>
</html>

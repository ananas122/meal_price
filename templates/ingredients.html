<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produits avec Prix et Catégories</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.7.12/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
    <style>
        /* Style neutre pour les en-têtes de colonnes */
        .dataTables thead th {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            color: #333;
        }

        .nutriscore { width: 50px; } /* Rendre la colonne Nutri-Score plus petite */
    </style>
</head>
<body>
    <h1>Recherche de produit sur Open Food Facts</h1>
    <input type="text" id="searchQuery" placeholder="Entrez le nom du produit" />
    <button onclick="searchProduct()">Rechercher</button>
    <table id="productsTable" class="display">
        <thead>
            <tr>
                <th>Photo</th>
                <th>Nom</th>
                <th>Marque</th>
                <th class="nutriscore">Nutri-Score</th>
                <th>Ingredients</th>
                <th>Prix</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <!-- Modale pour les ingrédients -->
    <div class="modal fade" id="ingredientsModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Ingrédients</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Le contenu des ingrédients sera injecté ici -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
   
<script>
$(document).ready(function() {
    var table = $('#productsTable').DataTable({
        "columnDefs": [
            { "orderable": false, "targets": [0, 5, 6] },
            { "className": "nutriscore", "targets": [3] }
        ]
    });

    // Chargez les prix sauvegardés lorsque la page est chargée
    loadPrices();
});

function searchProduct() {
    var query = $('#searchQuery').val();
    if (query) {
        fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${query}&search_simple=1&action=process&json=1`)
            .then(response => response.json())
            .then(data => {
                if (data.products.length === 0) {
                    alert('Aucun produit trouvé.');
                    return;
                }
                updateTable(data.products);
            })
            .catch(error => {
                console.error(error);
                alert('Erreur lors de la recherche de produits.');
            });
    } else {
        alert('Veuillez entrer un nom de produit.');
    }
}

function updateTable(products) {
    var table = $('#productsTable').DataTable();
    table.clear();
    products.forEach(product => {
        var priceId = 'price-' + product._id;
        var ingredients = product.ingredients_text_fr || 'Inconnu';
        table.row.add([
            product.image_url ? `<img src="${product.image_url}" style="width:50px;height:auto;">` : 'Pas d\'image',
            product.product_name || 'Inconnu',
            product.brands || 'Inconnu',
            product.nutrition_grades || 'Inconnu',
            `<button type="button" class="btn btn-info" onclick="showIngredients('${ingredients.replace(/'/g, "\\'")}')">Infos</button>`,
            `<input type="number" id="${priceId}" placeholder="€" style="width:70px;" value="${localStorage.getItem(priceId) || ''}">`,
            `<button onclick="savePrice('${product._id}')">Sauvegarder</button>`
        ]);
    });
    table.draw();
}

function showIngredients(ingredients) {
    console.log('showIngredients called with:', ingredients);
    $('#ingredientsModal .modal-body').text(ingredients);
    $('#ingredientsModal').modal('show');
}


function savePrice(productId) {
    var priceId = 'price-' + productId;
    var price = $('#' + priceId).val();
    localStorage.setItem(priceId, price);
    alert('Prix sauvegardé pour le produit ID ' + productId);
}

function loadPrices() {
    $('#productsTable input[type="number"]').each(function() {
        var priceId = $(this).attr('id');
        $(this).val(localStorage.getItem(priceId) || '');
    });
}
</script>
<script>
// Initialiser Supabase
        const supabaseUrl = 'https://phkrkssbltpeowygwtvz.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoa3Jrc3NibHRwZW93eWd3dHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTkwNTg5NDcsImV4cCI6MjAxNDYzNDk0N30.3wZg6O36smQV972LOU_fL6RpQPoCihC5shkaBTLaFSc';
        const supabase = Supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Vous pouvez maintenant utiliser `supabase` pour interagir avec votre base de données Supabase
    </script>
</body>
</html>
